{% extends "layout1.html" %}

{% block content %}
<div class="flex text-5xl font-bold mb-5">Notify</div>
<div class="flex text-xl my-10">This is a sample page for testing notifications. This will be used later to notify manually. The only options will be the different groups. </div>
<div class="max-w-md mx-auto bg-primaryHighlight shadow-md rounded-lg p-6 space-y-4">
    <button
      class="w-full py-2 px-4 bg-primaryBg text-white rounded hover:bg-accent"
      onclick="sendNotification({modes:['sms','whatsapp','call','email'],incident_groups:['trespassing']})"
    >
      send to trespassing group (all modes)
    </button>
    <button
      class="w-full py-2 px-4 bg-primaryBg text-white rounded hover:bg-accent"
      onclick="sendNotification({modes:[],incident_groups:['trespassing','fire']})"
    >
        send to trespassing and fire group (all modes)
    </button>
    <button
      class="w-full py-2 px-4 bg-primaryBg text-white rounded hover:bg-accent"
      onclick="sendNotification({
    phone: '+1234567890',
    email: 'user@example.com',
    incidentId: '123',
    incidentType: 'Security Breach',
    sendSms: true,
    sendCall: true,
    sendEmail: true,
    sendWhatsapp: true});"
    >
      send to all groups (sms only)
    </button>
  </div>

  
  <script>
    async function sendNotification({
        phone = null,
        email = null,
        incidentId = null,
        incidentType = null,
        sendSms = false,
        sendCall = false,
        sendEmail = false,
        sendWhatsapp = false
    } = {}) {
        // Validate required parameters based on notification types
        if ((sendSms || sendCall || sendWhatsapp) && !phone) {
            alert("Phone number is required for SMS, call, or WhatsApp notifications");
            return;
        }
        
        if (sendEmail && !email) {
            alert("Email is required for email notifications");
            return;
        }
        
        if (!incidentId || !incidentType) {
            alert("Incident ID and type are required");
            return;
        }

        // If no notification types are selected
        if (!sendSms && !sendCall && !sendEmail && !sendWhatsapp) {
            alert("Please select at least one notification type");
            return;
        }

        const data = {
            phone,
            email,
            incident_id: incidentId,
            incident_type: incidentType,
            send_sms: sendSms,
            send_call: sendCall,
            send_email: sendEmail,
            send_whatsapp: sendWhatsapp
        };

        try {
            const response = await fetch("{% url 'notify_api' %}", {
                method: "POST",
                headers: {
                    "Content-Type": "application/json",
                    "X-CSRFToken": "{{ csrf_token }}",
                },
                body: JSON.stringify(data),
            });
            
            const result = await response.json();
            
            if (result.success) {
                // Create a message showing which notifications were sent
                const sentTypes = [];
                if (sendSms) sentTypes.push("SMS");
                if (sendCall) sentTypes.push("Call");
                if (sendEmail) sentTypes.push("Email");
                if (sendWhatsapp) sentTypes.push("WhatsApp");
                
                alert(`Notifications sent successfully via: ${sentTypes.join(", ")}`);
            } else {
                alert(`Failed to send notifications: ${result.error}`);
            }
        } catch (error) {
            alert(`Error sending notifications: ${error}`);
        }
    }
</script>
{% endblock content %}